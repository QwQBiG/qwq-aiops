# 前端 404 错误修复指南

## 问题描述

浏览器访问前端时出现以下错误：
```
GET http://192.168.50.15:8081/assets/_plugin-vue_export-helper-DlAUqK2U.js 
net::ERR_ABORTED 404 (Not Found)
```

## 根本原因

**前端资源文件没有被正确 embed 到 Go 二进制文件中。**

这通常发生在以下情况：
1. 前端构建后，没有重新构建 Docker 镜像
2. Docker 构建时 `frontend/dist` 目录不存在或为空
3. Dockerfile 中的文件复制逻辑有问题

## 解决步骤

### 方法 1：使用自动修复脚本（推荐）

在 **Ubuntu 服务器**上执行：

```bash
# 1. 上传脚本到服务器
# 将 fix-and-rebuild.sh 上传到 ~/qwq-aiops/ 目录

# 2. 赋予执行权限
chmod +x fix-and-rebuild.sh

# 3. 运行修复脚本
./fix-and-rebuild.sh
```

脚本会自动完成：
- ✓ 清理旧的前端构建
- ✓ 重新构建前端
- ✓ 验证构建结果
- ✓ 重新构建 Docker 镜像（不使用缓存）
- ✓ 启动服务
- ✓ 健康检查

### 方法 2：手动修复

如果自动脚本失败，按以下步骤手动操作：

#### 步骤 1：重新构建前端

```bash
cd ~/qwq-aiops/frontend

# 清理旧构建
rm -rf dist

# 重新构建
npm run build

# 验证构建结果
ls -lh dist/assets/ | grep plugin
```

应该看到类似输出：
```
_plugin-vue_export-helper-DlAUqK2U.js
```

#### 步骤 2：验证前端文件完整性

```bash
# 检查关键文件
test -f dist/index.html && echo "✓ index.html 存在" || echo "✗ index.html 不存在"
test -d dist/assets && echo "✓ assets 目录存在" || echo "✗ assets 目录不存在"

# 统计文件数量
find dist -type f | wc -l
```

应该有 100+ 个文件。

#### 步骤 3：重新构建 Docker 镜像

```bash
cd ~/qwq-aiops

# 停止现有容器
docker compose down

# 重新构建（不使用缓存，这很重要！）
docker compose build --no-cache

# 启动服务
docker compose up -d

# 查看日志
docker compose logs -f qwq
```

#### 步骤 4：验证修复结果

```bash
# 等待服务启动（约 10 秒）
sleep 10

# 测试 index.html
curl -I http://localhost:8081/

# 测试 plugin helper 文件
curl -I http://localhost:8081/assets/_plugin-vue_export-helper-DlAUqK2U.js
```

应该都返回 `200 OK`。

## 诊断工具

### 使用诊断脚本

```bash
# 上传 diagnose-frontend.sh 到服务器
chmod +x diagnose-frontend.sh
./diagnose-frontend.sh
```

诊断脚本会检查：
- 本地前端构建状态
- Docker 容器内的文件
- HTTP 访问状态
- 给出具体的修复建议

### 手动诊断命令

```bash
# 1. 检查本地前端构建
ls -lh frontend/dist/assets/ | grep plugin

# 2. 检查容器内的文件
docker exec qwq ls -lh /app/internal/server/dist/assets/ | grep plugin

# 3. 检查 HTTP 访问
curl -I http://localhost:8081/assets/_plugin-vue_export-helper-DlAUqK2U.js

# 4. 查看容器日志
docker compose logs qwq | grep -i "static\|embed\|404"
```

## 常见问题

### Q1: 构建时提示 "terser not found"

**原因**: `vite.config.js` 配置了 `minify: 'terser'` 但没有安装 terser。

**解决**: 已修复为使用 `minify: 'esbuild'`（Vite 内置）。

### Q2: Docker 镜像源返回 401

**原因**: 镜像源配置问题或网络问题。

**解决**:
```bash
# 检查 Docker 镜像源
cat /etc/docker/daemon.json

# 如果需要，配置国内镜像源
sudo tee /etc/docker/daemon.json <<EOF
{
  "registry-mirrors": [
    "https://docker.m.daocloud.io",
    "https://mirror.ccs.tencentyun.com"
  ]
}
EOF

# 重启 Docker
sudo systemctl restart docker
```

### Q3: 前端构建成功，但容器内文件不存在

**原因**: Docker 使用了缓存的旧镜像层。

**解决**: 必须使用 `--no-cache` 重新构建：
```bash
docker compose build --no-cache
```

### Q4: 浏览器仍然显示 404

**原因**: 浏览器缓存了旧的文件。

**解决**:
1. 清除浏览器缓存（Ctrl+Shift+Delete）
2. 使用无痕模式访问
3. 强制刷新（Ctrl+F5）

## 验证修复成功

修复成功后，应该满足以下条件：

1. ✓ 前端构建产物存在
   ```bash
   ls frontend/dist/assets/_plugin-vue_export-helper-*.js
   ```

2. ✓ 容器内文件存在
   ```bash
   docker exec qwq ls /app/internal/server/dist/assets/_plugin-vue_export-helper-*.js
   ```

3. ✓ HTTP 访问返回 200
   ```bash
   curl -I http://localhost:8081/assets/_plugin-vue_export-helper-DlAUqK2U.js
   # 应该返回: HTTP/1.1 200 OK
   ```

4. ✓ 浏览器控制台无错误
   - 打开浏览器开发者工具（F12）
   - 切换到 Console 标签
   - 刷新页面
   - 不应该有 404 错误

## 技术细节

### Dockerfile 文件复制逻辑

```dockerfile
# 从前端构建阶段复制前端资源
COPY --from=frontend-builder /app/frontend/dist ./frontend/dist

# 复制后端源码
COPY internal/ ./internal/

# 将前端资源内容移动到正确位置
RUN mkdir -p ./internal/server/dist && \
    cp -r ./frontend/dist/* ./internal/server/dist/ && \
    rm -rf ./frontend
```

**关键点**:
- 使用 `cp -r ./frontend/dist/*` 复制**内容**而不是目录本身
- 确保 `internal/server/dist/` 目录结构正确
- Go embed 指令 `//go:embed dist` 会将整个 dist 目录打包到二进制文件

### Go embed 机制

```go
//go:embed dist
var frontendDist embed.FS
```

这个指令会在**编译时**将 `internal/server/dist` 目录的所有文件打包到 Go 二进制文件中。

**重要**: 如果构建时 `dist` 目录不存在或为空，embed 会失败或打包空目录。

## 需要帮助？

如果按照以上步骤仍然无法解决问题，请提供以下信息：

1. 诊断脚本输出
   ```bash
   ./diagnose-frontend.sh > diagnosis.txt 2>&1
   ```

2. Docker 构建日志
   ```bash
   docker compose build --no-cache 2>&1 | tee build.log
   ```

3. 容器日志
   ```bash
   docker compose logs qwq > container.log
   ```

4. 浏览器控制台截图（F12 → Console 标签）
