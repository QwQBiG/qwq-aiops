# ğŸš€ æ„å»ºä¼˜åŒ–è¯´æ˜

## é—®é¢˜æè¿°

æ‚¨é‡åˆ°çš„é—®é¢˜ï¼š

1. **äº¤å‰ç¼–è¯‘æ…¢**ï¼šARM64 ç³»ç»Ÿç¼–è¯‘ AMD64 ç¨‹åºéå¸¸æ…¢
2. **ç½‘ç»œæ…¢**ï¼šä¸‹è½½ä¾èµ–å’Œè½¯ä»¶åŒ…å¾ˆæ…¢

## âœ… å·²ä¼˜åŒ–

æˆ‘å·²ç»å¯¹ Dockerfile è¿›è¡Œäº†å…¨é¢ä¼˜åŒ–ï¼š

### 1. æ·»åŠ å›½å†…é•œåƒæº

**Alpine Linux é•œåƒæº**ï¼ˆ3 ä¸ªé˜¶æ®µéƒ½æ·»åŠ äº†ï¼‰ï¼š
```dockerfile
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories
```

**npm é•œåƒæº**ï¼š
```dockerfile
RUN npm config set registry https://registry.npmmirror.com
```

**Go æ¨¡å—ä»£ç†**ï¼ˆå·²æœ‰ï¼‰ï¼š
```dockerfile
ENV GOPROXY=https://goproxy.cn,https://goproxy.io,direct
```

### 2. ä¿®å¤æ¶æ„é—®é¢˜

**è‡ªåŠ¨é€‚é…ç›®æ ‡æ¶æ„**ï¼Œé¿å…äº¤å‰ç¼–è¯‘ï¼š
```dockerfile
ARG TARGETARCH
RUN GOARCH=${TARGETARCH:-amd64} go build ...
```

è¿™æ ·ï¼š
- **ARM64 ç³»ç»Ÿ**ï¼šç›´æ¥ç¼–è¯‘ ARM64 ç¨‹åºï¼ˆå¿«ï¼‰
- **AMD64 ç³»ç»Ÿ**ï¼šç›´æ¥ç¼–è¯‘ AMD64 ç¨‹åºï¼ˆå¿«ï¼‰
- ä¸å†éœ€è¦äº¤å‰ç¼–è¯‘ï¼

### 3. ä¼˜åŒ–ç¼–è¯‘é…ç½®

```dockerfile
ENV CGO_ENABLED=0  # ç¦ç”¨ CGOï¼ŒåŠ å¿«ç¼–è¯‘
```

## ğŸš€ ç°åœ¨å¯ä»¥é‡æ–°æ„å»º

### æ–¹æ³• 1ï¼šä½¿ç”¨é‡æ–°æ„å»ºè„šæœ¬ï¼ˆæ¨èï¼‰

**Windows**ï¼š
```cmd
rebuild.bat
```

**Linux/macOS**ï¼š
```bash
./rebuild.sh
```

### æ–¹æ³• 2ï¼šæ‰‹åŠ¨æ„å»º

```bash
# æ¸…ç†æ—§çš„æ„å»º
docker-compose down
docker system prune -f

# é‡æ–°æ„å»º
docker-compose build --no-cache

# å¯åŠ¨æœåŠ¡
docker-compose up -d
```

## â±ï¸ é¢„æœŸæ„å»ºæ—¶é—´

ä¼˜åŒ–åçš„æ„å»ºæ—¶é—´ï¼ˆARM64 ç³»ç»Ÿï¼‰ï¼š

| é˜¶æ®µ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | è¯´æ˜ |
|------|--------|--------|------|
| å‰ç«¯æ„å»º | 5-8 åˆ†é’Ÿ | 2-3 åˆ†é’Ÿ | ä½¿ç”¨ npm å›½å†…é•œåƒ |
| Go ä¾èµ–ä¸‹è½½ | 3-5 åˆ†é’Ÿ | 1-2 åˆ†é’Ÿ | ä½¿ç”¨ goproxy.cn |
| Go ç¼–è¯‘ | 10-15 åˆ†é’Ÿ | 2-3 åˆ†é’Ÿ | ä¸å†äº¤å‰ç¼–è¯‘ |
| è¿è¡Œæ—¶é•œåƒ | 2-3 åˆ†é’Ÿ | 1 åˆ†é’Ÿ | ä½¿ç”¨ Alpine å›½å†…é•œåƒ |
| **æ€»è®¡** | **20-30 åˆ†é’Ÿ** | **6-9 åˆ†é’Ÿ** | **æé€Ÿ 3-4 å€** |

## ğŸ“Š ä¼˜åŒ–è¯¦æƒ…

### ä¼˜åŒ– 1ï¼šAlpine é•œåƒæº

**ä¼˜åŒ–å‰**ï¼š
```
ä» dl-cdn.alpinelinux.org ä¸‹è½½ï¼ˆå›½å¤–æœåŠ¡å™¨ï¼Œæ…¢ï¼‰
```

**ä¼˜åŒ–å**ï¼š
```
ä» mirrors.aliyun.com ä¸‹è½½ï¼ˆé˜¿é‡Œäº‘é•œåƒï¼Œå¿«ï¼‰
```

**æ•ˆæœ**ï¼šapk å®‰è£…é€Ÿåº¦æå‡ 5-10 å€

### ä¼˜åŒ– 2ï¼šnpm é•œåƒæº

**ä¼˜åŒ–å‰**ï¼š
```
ä» registry.npmjs.org ä¸‹è½½ï¼ˆå›½å¤–æœåŠ¡å™¨ï¼Œæ…¢ï¼‰
```

**ä¼˜åŒ–å**ï¼š
```
ä» registry.npmmirror.com ä¸‹è½½ï¼ˆæ·˜å®é•œåƒï¼Œå¿«ï¼‰
```

**æ•ˆæœ**ï¼šnpm å®‰è£…é€Ÿåº¦æå‡ 5-10 å€

### ä¼˜åŒ– 3ï¼šGo æ¨¡å—ä»£ç†

**ä¼˜åŒ–å‰**ï¼š
```
ä» proxy.golang.org ä¸‹è½½ï¼ˆGoogle æœåŠ¡å™¨ï¼Œè¶…æ—¶ï¼‰
```

**ä¼˜åŒ–å**ï¼š
```
ä» goproxy.cn ä¸‹è½½ï¼ˆä¸ƒç‰›äº‘é•œåƒï¼Œå¿«ï¼‰
```

**æ•ˆæœ**ï¼šGo ä¾èµ–ä¸‹è½½é€Ÿåº¦æå‡ 10 å€ä»¥ä¸Š

### ä¼˜åŒ– 4ï¼šæ¶æ„è‡ªé€‚åº”

**ä¼˜åŒ–å‰**ï¼š
```dockerfile
# å›ºå®šç¼–è¯‘ AMD64ï¼ŒARM64 ç³»ç»Ÿéœ€è¦äº¤å‰ç¼–è¯‘ï¼ˆæ…¢ï¼‰
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build ...
```

**ä¼˜åŒ–å**ï¼š
```dockerfile
# è‡ªåŠ¨é€‚é…æ¶æ„ï¼Œä¸éœ€è¦äº¤å‰ç¼–è¯‘ï¼ˆå¿«ï¼‰
ARG TARGETARCH
RUN GOARCH=${TARGETARCH:-amd64} go build ...
```

**æ•ˆæœ**ï¼š
- ARM64 ç³»ç»Ÿï¼šç¼–è¯‘é€Ÿåº¦æå‡ 5-10 å€
- AMD64 ç³»ç»Ÿï¼šæ— å½±å“ï¼ˆæœ¬æ¥å°±å¿«ï¼‰

## ğŸ” éªŒè¯ä¼˜åŒ–

æ„å»ºæ—¶æŸ¥çœ‹æ—¥å¿—ï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```
=> [frontend-builder 2/7] RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories
=> [frontend-builder 3/7] RUN npm config set registry https://registry.npmmirror.com
=> [backend-builder 3/11] RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories
=> [backend-builder 5/11] ENV GOPROXY=https://goproxy.cn,https://goproxy.io,direct
```

å¦‚æœçœ‹åˆ°è¿™äº›ï¼Œè¯´æ˜ä¼˜åŒ–ç”Ÿæ•ˆäº†ï¼

## ğŸ¯ ç³»ç»Ÿæ¶æ„æ£€æµ‹

æŸ¥çœ‹æ‚¨çš„ç³»ç»Ÿæ¶æ„ï¼š

```bash
# æŸ¥çœ‹ç³»ç»Ÿæ¶æ„
uname -m

# è¾“å‡ºè¯´æ˜ï¼š
# x86_64 æˆ– amd64 = AMD64 æ¶æ„
# aarch64 æˆ– arm64 = ARM64 æ¶æ„
```

æŸ¥çœ‹ Docker æ„å»ºçš„ç›®æ ‡æ¶æ„ï¼š

```bash
# æŸ¥çœ‹ Docker æ„å»ºä¿¡æ¯
docker buildx ls

# æŸ¥çœ‹é•œåƒæ¶æ„
docker inspect qwq-aiops:latest | grep Architecture
```

## ğŸ’¡ è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®

### 1. ä½¿ç”¨ BuildKit ç¼“å­˜

åœ¨ `.env` æˆ–ç¯å¢ƒå˜é‡ä¸­è®¾ç½®ï¼š

```bash
DOCKER_BUILDKIT=1
COMPOSE_DOCKER_CLI_BUILD=1
```

ç„¶åæ„å»ºï¼š

```bash
docker-compose build
```

### 2. å¹¶è¡Œæ„å»º

å¦‚æœæ‚¨çš„æœºå™¨æ€§èƒ½å¥½ï¼š

```bash
docker-compose build --parallel
```

### 3. ä½¿ç”¨æœ¬åœ°ç¼“å­˜

å¦‚æœæ‚¨æœ¬åœ°å·²ç»æœ‰ä¾èµ–ï¼š

```bash
# å‰ç«¯
cd frontend
npm install
cd ..

# åç«¯
go mod download

# ç„¶åæ„å»ºä¼šä½¿ç”¨æœ¬åœ°ç¼“å­˜
docker-compose build
```

### 4. å¢åŠ  Docker èµ„æº

åœ¨ Docker Desktop è®¾ç½®ä¸­ï¼š
- **å†…å­˜**ï¼š8GB+ï¼ˆæ¨èï¼‰
- **CPU**ï¼š4 æ ¸+ï¼ˆæ¨èï¼‰
- **ç£ç›˜**ï¼š50GB+

## ğŸ“ ä¿®æ”¹çš„å†…å®¹

### Dockerfile ä¿®æ”¹

1. âœ… **Stage 1 (frontend-builder)**
   - æ·»åŠ  Alpine é•œåƒæº
   - æ·»åŠ  npm é•œåƒæº

2. âœ… **Stage 2 (backend-builder)**
   - æ·»åŠ  Alpine é•œåƒæº
   - ä¼˜åŒ– Go ç¼–è¯‘é…ç½®
   - ä¿®å¤æ¶æ„è‡ªé€‚åº”

3. âœ… **Stage 3 (runtime)**
   - æ·»åŠ  Alpine é•œåƒæº
   - ä¿®å¤ kubectl æ¶æ„è‡ªé€‚åº”

## âŒ å¦‚æœè¿˜æ˜¯æ…¢

### æ£€æŸ¥ç½‘ç»œ

```bash
# æµ‹è¯• Alpine é•œåƒæº
curl -I https://mirrors.aliyun.com

# æµ‹è¯• npm é•œåƒæº
curl -I https://registry.npmmirror.com

# æµ‹è¯• Go ä»£ç†
curl -I https://goproxy.cn
```

### æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

```bash
# æŸ¥çœ‹è¯¦ç»†æ„å»ºè¿‡ç¨‹
docker-compose build --progress=plain --no-cache
```

### å°è¯•å…¶ä»–é•œåƒæº

å¦‚æœé˜¿é‡Œäº‘é•œåƒä¹Ÿæ…¢ï¼Œå¯ä»¥å°è¯•å…¶ä»–é•œåƒï¼š

**Alpine é•œåƒæº**ï¼š
```dockerfile
# æ¸…åå¤§å­¦é•œåƒ
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.tuna.tsinghua.edu.cn/g' /etc/apk/repositories

# ä¸­ç§‘å¤§é•œåƒ
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g' /etc/apk/repositories
```

**npm é•œåƒæº**ï¼š
```dockerfile
# è…¾è®¯äº‘é•œåƒ
RUN npm config set registry https://mirrors.cloud.tencent.com/npm/

# åä¸ºäº‘é•œåƒ
RUN npm config set registry https://mirrors.huaweicloud.com/repository/npm/
```

## ğŸ†˜ éœ€è¦å¸®åŠ©ï¼Ÿ

1. **æŸ¥çœ‹æ„å»ºæ—¥å¿—**
   ```bash
   docker-compose build --progress=plain 2>&1 | tee build.log
   ```

2. **æ£€æŸ¥ç³»ç»Ÿèµ„æº**
   ```bash
   # æŸ¥çœ‹ Docker èµ„æºä½¿ç”¨
   docker system df
   
   # æŸ¥çœ‹ç³»ç»Ÿèµ„æº
   top  # Linux/macOS
   # æˆ–ä»»åŠ¡ç®¡ç†å™¨ï¼ˆWindowsï¼‰
   ```

3. **æäº¤ Issue**
   - GitHub: https://github.com/QwQBiG/qwq-aiops/issues
   - é™„ä¸Š `build.log` å’Œç³»ç»Ÿä¿¡æ¯

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **[NETWORK_FIX.md](NETWORK_FIX.md)** - ç½‘ç»œé—®é¢˜ä¿®å¤
- **[ç½‘ç»œé—®é¢˜å·²ä¿®å¤.md](ç½‘ç»œé—®é¢˜å·²ä¿®å¤.md)** - å¿«é€Ÿå‚è€ƒ
- **[START_HERE.md](START_HERE.md)** - å¿«é€Ÿå¼€å§‹

---

**ä¼˜åŒ–æ—¶é—´**: 2025-12-07  
**çŠ¶æ€**: âœ… å·²å…¨é¢ä¼˜åŒ–ï¼Œé¢„è®¡æé€Ÿ 3-4 å€  
**ä¸‹ä¸€æ­¥**: è¿è¡Œ `rebuild.bat` æˆ– `./rebuild.sh` é‡æ–°æ„å»º
