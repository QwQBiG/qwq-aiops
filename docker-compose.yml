services:
  qwq:
    # 本地构建（推荐）
    build: .
    image: qwq-aiops:latest
    # 或者使用 GitHub Container Registry 镜像（需要先发布）
    # image: ghcr.io/qwqbig/qwq-aiops:latest
    container_name: qwq
    restart: unless-stopped
    ports:
      - "8081:8080"  # 主服务端口（宿主机8081映射到容器8080）
    volumes:
      # Docker socket（用于容器管理）
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # 数据持久化
      - ./data:/app/data
      - ./logs:/app/logs
      - ./backups:/app/backups
      # 配置文件（可选）
      - ./config.json:/app/config.json:ro
    environment:
      # 基础配置
      - TZ=Asia/Shanghai
      - PORT=8080
      - LOG_LEVEL=info
      - ENVIRONMENT=production
      
      # 数据库配置
      - DB_TYPE=sqlite
      - DB_PATH=/app/data/qwq.db
      
      # AI 配置（根据需要修改）
      - AI_PROVIDER=openai
      # - OPENAI_API_KEY=your-api-key-here
      # - OLLAMA_HOST=http://ollama:11434
      
      # 安全配置（请修改为强密码）
      - JWT_SECRET=change-this-to-random-secret
      - ENCRYPTION_KEY=change-this-to-32-byte-key
    networks:
      - qwq-network
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    # 资源限制
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # MySQL 数据库（可选，生产环境推荐）
  mysql:
    image: mysql:8.0
    container_name: qwq-mysql
    restart: unless-stopped
    ports:
      - "3307:3306"  # 宿主机端口改为 3307，避免冲突
    environment:
      - MYSQL_ROOT_PASSWORD=change-this-password
      - MYSQL_DATABASE=qwq
      - MYSQL_USER=qwq
      - MYSQL_PASSWORD=change-this-password
      - TZ=Asia/Shanghai
    volumes:
      - mysql-data:/var/lib/mysql
      - ./config/mysql.cnf:/etc/mysql/conf.d/custom.cnf:ro
    command: 
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-authentication-plugin=mysql_native_password
    networks:
      - qwq-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p$$MYSQL_ROOT_PASSWORD"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G

  # Redis 缓存（可选）
  redis:
    image: redis:7-alpine
    container_name: qwq-redis
    restart: unless-stopped
    ports:
      - "6380:6379"  # 宿主机端口改为 6380，避免冲突
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    networks:
      - qwq-network

  # Prometheus 监控（可选）
  prometheus:
    image: prom/prometheus:latest
    container_name: qwq-prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    networks:
      - qwq-network

  # Grafana 可视化（可选）
  grafana:
    image: grafana/grafana:latest
    container_name: qwq-grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_INSTALL_PLUGINS=grafana-clock-panel
    volumes:
      - grafana-data:/var/lib/grafana
    networks:
      - qwq-network

networks:
  qwq-network:
    driver: bridge

volumes:
  mysql-data:
  redis-data:
  prometheus-data:
  grafana-data:
