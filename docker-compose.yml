services:
  qwq:
    # 本地构建（推荐）
    build: .
    image: qwq-aiops:latest
    # 或者使用 GitHub Container Registry 镜像（需要先发布）
    # image: ghcr.io/qwqbig/qwq-aiops:latest
    container_name: qwq
    restart: unless-stopped
    ports:
      - "8081:8080"  # 主服务端口（宿主机8081映射到容器8080）
    volumes:
      # Docker socket（用于容器管理）
      # Windows 使用命名管道，Linux/Mac 使用 socket
      - //var/run/docker.sock:/var/run/docker.sock:ro
      # 数据持久化
      - ./data:/app/data
      - ./logs:/app/logs
      - ./backups:/app/backups
    environment:
      # 基础配置
      - TZ=Asia/Shanghai
      - PORT=8080
      - LOG_LEVEL=info
      - ENVIRONMENT=production
      
      # 数据库配置
      - DB_TYPE=sqlite
      - DB_PATH=/app/data/qwq.db
      
      # ============================================
      # AI 配置（必须配置）
      # ============================================
      # 从 .env 文件读取配置
      # 请编辑 .env 文件配置 AI 服务
      - AI_PROVIDER=${AI_PROVIDER:-openai}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-https://api.openai.com/v1}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-3.5-turbo}
      - OLLAMA_HOST=${OLLAMA_HOST:-http://host.docker.internal:11434}
      - OLLAMA_MODEL=${OLLAMA_MODEL:-qwen2.5:7b}
      - AI_TIMEOUT=${AI_TIMEOUT:-60}
      
      # 配置方法：
      # 1. 复制 .env.example 为 .env
      # 2. 编辑 .env 文件，取消 AI 配置的注释
      # 3. 填入正确的配置值
      # 4. 重启服务: docker compose restart qwq
      # ============================================
      
      # 通知配置（从 .env 文件读取）
      - DINGTALK_WEBHOOK=${DINGTALK_WEBHOOK:-}
      - WECHAT_WEBHOOK=${WECHAT_WEBHOOK:-}
      - SLACK_WEBHOOK=${SLACK_WEBHOOK:-}
      - SMTP_HOST=${SMTP_HOST:-}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_USER:-}
      - SMTP_PASSWORD=${SMTP_PASSWORD:-}
      - SMTP_FROM=${SMTP_FROM:-}
      
      # 安全配置（请修改为强密码）
      - JWT_SECRET=${JWT_SECRET:-change-this-to-random-secret}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY:-change-this-to-32-byte-key}
      
      # Web 认证配置
      - WEB_USER=${WEB_USER:-}
      - WEB_PASSWORD=${WEB_PASSWORD:-}
    networks:
      - qwq-network
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    # 资源限制
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  # MySQL 数据库（可选，生产环境推荐）
  mysql:
    image: mysql:8.0
    container_name: qwq-mysql
    restart: unless-stopped
    ports:
      - "3308:3306"  # 使用 3308 端口，避免与常见服务冲突
    environment:
      - MYSQL_ROOT_PASSWORD=change-this-password
      - MYSQL_DATABASE=qwq
      - MYSQL_USER=qwq
      - MYSQL_PASSWORD=change-this-password
      - TZ=Asia/Shanghai
    volumes:
      - mysql-data:/var/lib/mysql
      - ./config/mysql.cnf:/etc/mysql/conf.d/custom.cnf:ro
    command: 
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-authentication-plugin=mysql_native_password
    networks:
      - qwq-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p$$MYSQL_ROOT_PASSWORD"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G

  # Redis 缓存（可选）
  redis:
    image: redis:7-alpine
    container_name: qwq-redis
    restart: unless-stopped
    ports:
      - "6380:6379"  # 使用 6380 端口，避免与常见服务冲突
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    networks:
      - qwq-network

  # Prometheus 监控（可选）
  prometheus:
    image: prom/prometheus:latest
    container_name: qwq-prometheus
    restart: unless-stopped
    ports:
      - "9091:9090"  # 使用 9091 端口，避免与常见服务冲突
    volumes:
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    networks:
      - qwq-network

  # Grafana 可视化（可选）
  grafana:
    image: grafana/grafana:latest
    container_name: qwq-grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_INSTALL_PLUGINS=grafana-clock-panel
    volumes:
      - grafana-data:/var/lib/grafana
    networks:
      - qwq-network

networks:
  qwq-network:
    driver: bridge

volumes:
  mysql-data:
  redis-data:
  prometheus-data:
  grafana-data:
