# 🔧 Docker 镜像拉取失败解决方案

## 问题描述

在构建 Docker 镜像时出现以下错误：

```
ERROR [internal] load metadata for docker.io/library/node:18-alpine
ERROR [internal] load metadata for docker.io/library/golang:1.23-alpine
ERROR [internal] load metadata for docker.io/library/alpine:3.19

failed to solve: golang:1.23-alpine: failed to resolve source metadata for 
docker.io/library/golang:1.23-alpine: docker.io/library/golang:1.23-alpine: not found
```

## 原因分析

1. **网络连接问题**：无法访问 Docker Hub (docker.io)
2. **DNS 解析问题**：域名解析失败
3. **镜像源未配置**：未配置国内镜像加速源
4. **防火墙限制**：公司或学校网络限制

## 解决方案

### 方案 1：使用一键部署脚本（推荐）⭐

一键部署脚本已经包含了镜像预拉取功能：

```bash
chmod +x 一键部署.sh
sudo ./一键部署.sh
```

脚本会自动：
1. 配置 Docker 镜像源
2. 重启 Docker 服务
3. 预拉取所需的基础镜像
4. 构建并启动服务

### 方案 2：手动拉取镜像

如果一键部署失败，可以先手动拉取镜像：

**Linux/macOS：**
```bash
chmod +x 手动拉取镜像.sh
./手动拉取镜像.sh
```

**Windows：**
```cmd
手动拉取镜像.bat
```

### 方案 3：配置 Docker 镜像源

#### Linux 系统

1. **创建或编辑 Docker 配置文件**：

```bash
sudo mkdir -p /etc/docker
sudo nano /etc/docker/daemon.json
```

2. **添加以下内容**：

```json
{
  "registry-mirrors": [
    "https://docker.m.daocloud.io",
    "https://reg-mirror.qiniu.com",
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com",
    "https://mirror.baidubce.com",
    "https://ccr.ccs.tencentyun.com"
  ],
  "dns": ["8.8.8.8", "8.8.4.4"]
}
```

3. **重启 Docker**：

```bash
sudo systemctl daemon-reload
sudo systemctl restart docker
```

4. **验证配置**：

```bash
docker info | grep -A 4 "Registry Mirrors"
```

#### Windows 系统

1. 右键点击 Docker Desktop 图标
2. 选择 "Settings" (设置)
3. 进入 "Docker Engine"
4. 添加镜像源配置：

```json
{
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com",
    "https://mirror.baidubce.com"
  ]
}
```

5. 点击 "Apply & Restart"

#### macOS 系统

1. 点击 Docker Desktop 图标
2. 选择 "Preferences" (偏好设置)
3. 进入 "Docker Engine"
4. 添加镜像源配置（同 Windows）
5. 点击 "Apply & Restart"

### 方案 4：手动拉取并重命名镜像

如果镜像源也无法访问，可以尝试从其他源拉取：

```bash
# 从 USTC 镜像源拉取
docker pull docker.mirrors.ustc.edu.cn/library/node:18-alpine
docker tag docker.mirrors.ustc.edu.cn/library/node:18-alpine node:18-alpine

docker pull docker.mirrors.ustc.edu.cn/library/golang:1.23-alpine
docker tag docker.mirrors.ustc.edu.cn/library/golang:1.23-alpine golang:1.23-alpine

docker pull docker.mirrors.ustc.edu.cn/library/alpine:3.19
docker tag docker.mirrors.ustc.edu.cn/library/alpine:3.19 alpine:3.19

# 删除临时镜像
docker rmi docker.mirrors.ustc.edu.cn/library/node:18-alpine
docker rmi docker.mirrors.ustc.edu.cn/library/golang:1.23-alpine
docker rmi docker.mirrors.ustc.edu.cn/library/alpine:3.19
```

### 方案 5：使用代理

如果有 HTTP 代理，可以配置 Docker 使用代理：

#### Linux 系统

1. **创建 Docker 服务配置目录**：

```bash
sudo mkdir -p /etc/systemd/system/docker.service.d
```

2. **创建代理配置文件**：

```bash
sudo nano /etc/systemd/system/docker.service.d/http-proxy.conf
```

3. **添加以下内容**（替换为你的代理地址）：

```ini
[Service]
Environment="HTTP_PROXY=http://proxy.example.com:8080"
Environment="HTTPS_PROXY=http://proxy.example.com:8080"
Environment="NO_PROXY=localhost,127.0.0.1"
```

4. **重启 Docker**：

```bash
sudo systemctl daemon-reload
sudo systemctl restart docker
```

#### Windows/macOS

在 Docker Desktop 设置中配置代理：
1. Settings -> Resources -> Proxies
2. 启用 "Manual proxy configuration"
3. 输入代理服务器地址和端口

### 方案 6：检查网络连接

1. **测试 Docker Hub 连接**：

```bash
# 测试 DNS 解析
nslookup registry-1.docker.io

# 测试网络连接
ping registry-1.docker.io

# 测试 HTTPS 连接
curl -I https://registry-1.docker.io/v2/
```

2. **测试镜像源连接**：

```bash
# 测试 USTC 镜像源
curl -I https://docker.mirrors.ustc.edu.cn/v2/

# 测试网易镜像源
curl -I https://hub-mirror.c.163.com/v2/
```

## 验证解决方案

配置完成后，验证是否可以拉取镜像：

```bash
# 测试拉取镜像
docker pull node:18-alpine

# 查看已拉取的镜像
docker images | grep node

# 预期输出
node    18-alpine    xxxxx    xxx MB
```

## 完整部署流程

解决镜像拉取问题后，按以下步骤部署：

```bash
# 1. 配置镜像源（如果还没配置）
sudo ./fix-docker-mirror.sh

# 2. 手动拉取镜像（可选，但推荐）
./手动拉取镜像.sh

# 3. 运行一键部署
sudo ./一键部署.sh

# 或者手动构建
docker compose build
docker compose up -d
```

## 常见问题

### Q1: 所有镜像源都无法访问怎么办？

**解决方案**：
1. 检查是否在公司或学校网络，可能有防火墙限制
2. 尝试使用手机热点或其他网络
3. 联系网络管理员开放 Docker Hub 访问权限
4. 考虑使用 VPN 或代理

### Q2: 拉取镜像速度很慢怎么办？

**解决方案**：
1. 确保已配置国内镜像源
2. 尝试不同的镜像源，选择速度最快的
3. 在网络空闲时段拉取镜像
4. 考虑使用本地镜像仓库

### Q3: 镜像拉取到一半失败怎么办？

**解决方案**：
```bash
# 清理失败的镜像
docker system prune -a

# 重新拉取
docker pull node:18-alpine
```

### Q4: Windows 系统如何配置镜像源？

**解决方案**：
1. 打开 Docker Desktop
2. Settings -> Docker Engine
3. 添加镜像源配置
4. Apply & Restart

### Q5: 如何验证镜像源是否生效？

**解决方案**：
```bash
# 查看 Docker 配置
docker info | grep -A 4 "Registry Mirrors"

# 预期输出
Registry Mirrors:
  https://docker.mirrors.ustc.edu.cn/
  https://hub-mirror.c.163.com/
  ...
```

## 推荐镜像源列表

| 镜像源 | 地址 | 速度 | 稳定性 | 学校网络 |
|--------|------|------|--------|----------|
| **DaoCloud** | https://docker.m.daocloud.io | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ✅ 推荐 |
| **七牛云** | https://reg-mirror.qiniu.com | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ✅ 推荐 |
| 中科大 | https://docker.mirrors.ustc.edu.cn | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⚠️ 部分学校封禁 |
| 网易 | https://hub-mirror.c.163.com | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⚠️ 部分学校封禁 |
| 百度 | https://mirror.baidubce.com | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ✅ 通常可用 |
| 腾讯云 | https://ccr.ccs.tencentyun.com | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ✅ 通常可用 |
| 阿里云 | https://xxxxxx.mirror.aliyuncs.com | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ✅ 通常可用 |

> **学校网络用户注意**：
> - ✅ **DaoCloud** 和 **七牛云** 在大多数学校网络环境下最稳定
> - ⚠️ 中科大、网易等镜像源可能被部分学校封禁
> - 阿里云镜像源需要注册账号后获取专属地址

## 技术支持

如果以上方案都无法解决问题：

1. **查看详细日志**：
   ```bash
   docker compose build --progress=plain
   ```

2. **提交 Issue**：
   - GitHub: https://github.com/QwQBiG/qwq-aiops/issues
   - 请附上完整的错误日志

3. **社区讨论**：
   - Discussions: https://github.com/QwQBiG/qwq-aiops/discussions

## 相关文档

- [Docker镜像源问题修复.md](Docker镜像源问题修复.md)
- [网络问题已修复.md](网络问题已修复.md)
- [一键部署说明.md](一键部署说明.md)
- [快速开始.md](快速开始.md)

---

**更新日期**：2025-12-07  
**状态**：✅ 已验证有效
