# 🤖 qwq - 极简主义 AIOps 智能运维助手

## 1. 项目概述
qwq 是一个基于 Go 语言开发的轻量级 AIOps（智能运维）Agent。它利用大语言模型（LLM）的推理能力，结合 Linux 系统原生命令，实现服务器的交互式排查和无人值守巡检。

### 核心亮点
- 🧠 **真正的 Agent 能力**：基于 OpenAI Native Function Calling 技术，AI 不仅能“说话”，还能“做事”（执行 Shell 命令）。
- 🛡️ **安全第一**：
  - **Human-in-the-loop**：交互模式下，所有命令执行前需用户确认。
  - **黑名单拦截**：内置高危命令（如 `rm -rf`）拦截机制。
  - **智能过滤**：自动识别并忽略权限报错（如 `dmesg` 权限不足）和空结果，防止误报。
- 🚀 **双模式运行**：
  - **Chat 模式**：像和真人专家聊天一样排查问题。
  - **Patrol 模式**：7x24小时后台巡检，异常自动推送到钉钉。
- ⚡ **极速轻量**：单二进制文件部署，无复杂依赖，资源占用极低。

## 2. 用户操作指南 (User Guide)

### 🛠️ 准备工作

#### 获取 API Key：
推荐使用硅基流动（SiliconFlow）的 Qwen/Qwen2.5-7B-Instruct 模型（免费且强大）。
> 注意：请使用您新生成的 Key，不要使用之前泄露的。

#### 设置环境变量：
在终端执行（或写入 `~/.bashrc`）：
```bash
export OPENAI_API_KEY=sk-您的密钥
```

#### 编译项目：

确保当前目录下有最新的 main.go，然后执行：
```bash
go build -o qwq main.go
```
编译成功后，当前目录会出现一个名为 qwq 的可执行文件。

## 💬 模式一：交互式排查 (Chat Mode)

**适用场景**：服务器出问题了，你需要 AI 帮你分析日志、查进程、看负载。

#### 启动命令：
```bash
./qwq chat
```

### 操作流程：

1. **提问**：输入你的需求，例如：“帮我看看为什么系统这么卡” 或 “检查一下 80 端口被谁占用了”。
2. **审批**：AI 会思考并申请执行命令（例如 `top` 或 `netstat`）。
   - 看到 `[?] 执行? (Y/n):` 时，按回车确认执行。
   - 如果觉得命令危险，按 `n` 拒绝。
3. **结果**：AI 会根据命令输出，给出最终的分析结论。
4. **退出**：输入 `exit` 或 `quit`。

---

## 🚨 模式二：无人值守巡检 (Patrol Mode)

**适用场景**：挂在后台，每 5 分钟自动检查一次磁盘、负载、OOM 和僵尸进程。有异常才发钉钉，没异常不打扰。

### 前置要求：
需要一个钉钉机器人的 Webhook 地址（在钉钉群设置 -> 智能群助手 -> 机器人 -> 添加自定义机器人 -> 安全设置必须勾选“自定义关键词”，填入“告警”）。

#### 方式 A：前台测试（调试用）
```bash
# 注意：URL 必须用双引号包裹，且不要加反斜杠
sudo -E ./qwq patrol --webhook="https://oapi.dingtalk.com/robot/send?access_token=您的Token"
```

> `sudo -E` 的作用是使用 `root` 权限运行（以便读取内核日志），同时保留当前用户的环境变量（API Key）。

#### 方式 B：后台静默运行（生产环境推荐）

使用 nohup 让程序在后台运行，即使关闭终端也不会停止。

```bash
sudo -E nohup ./qwq patrol --webhook="https://oapi.dingtalk.com/robot/send?access_token=您的Token" > patrol.log 2>&1 &
```

#### 常用运维操作：

**查看运行日志**：
```bash
tail -f patrol.log
```

**停止巡检**：
```bash
sudo pkill qwq
```

## 3. 常见问题排查 (Troubleshooting)

| **问题现象**                | **可能原因**               | **解决方案**                                                                                                                                                      |
|---------------------------|----------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| **API Error (无详细信息)**     | 运行的是旧版本程序         | 请执行 `go build -o qwq main.go` 重新编译，并使用 `./qwq` 运行。                                                                                                  |
| **API Error: 401 Unauthorized** | API Key 错误或未设置        | 检查 `echo $OPENAI_API_KEY`，确保 Key 有效且无多余空格。                                                                                                        |
| **钉钉收不到告警**             | 1. 关键词未设置<br>2. URL 格式错误 | 1. 钉钉后台安全设置必须包含关键词“告警”。<br>2. 启动命令中的 URL 不要加 `\` 转义符。                                                                              |
| **`dmesg` 报错 "不允许的操作"**  | 权限不足                   | 请使用 `sudo -E ./qwq ...` 运行程序。                                                                                                                             |
| **一直报 HTTP 400**           | 启动参数中的 URL 写错了    | 确保 `--webhook="..."` 中使用的是双引号，且 URL 完整。                                                                                                           |

---

## 4. 项目文件结构
```text
.
├── main.go        # 核心源码（包含 Chat 和 Patrol 逻辑）
├── qwq            # 编译后的二进制文件（由 go build 生成）
├── patrol.log     # 巡检模式的运行日志（由 nohup 生成）
└── go.mod         # Go 依赖定义
```

---