# ç«¯å£ç»Ÿä¸€ä¿®å¤å®ŒæˆæŠ¥å‘Š

## ğŸ¯ ä¿®å¤ç›®æ ‡

å°†æ‰€æœ‰ç¡¬ç¼–ç çš„ 8899 ç«¯å£ç»Ÿä¸€ä¿®æ”¹ä¸ºä»ç¯å¢ƒå˜é‡ PORT è¯»å–ï¼Œé»˜è®¤å€¼ 8080ã€‚

## âœ… å·²ä¿®å¤çš„æ–‡ä»¶

### 1. cmd/qwq/main.go âœ…

**ä¿®å¤å†…å®¹**:
- `runWebMode()`: ä»ç¯å¢ƒå˜é‡ PORT è¯»å–ç«¯å£ï¼Œé»˜è®¤ 8080
- `runGatewayMode()`: ä»ç¯å¢ƒå˜é‡ PORT è¯»å–ç½‘å…³ç«¯å£ï¼Œä» WEB_UI_PORT è¯»å– Web UI ç«¯å£

```go
// ä¿®å¤å
port := os.Getenv("PORT")
if port == "" {
    port = "8080"
}
server.Start(":" + port)
```

### 2. internal/server/server.go âœ…

**ä¿®å¤å†…å®¹**:
- ä¿®å¤æ—¥å¿—æ˜¾ç¤ºï¼Œæ­£ç¡®æ˜¾ç¤ºå®é™…ç«¯å£å·

```go
// ä¿®å¤å
displayPort := strings.TrimPrefix(port, ":")
logger.Info("ğŸš€ qwq Dashboard started at http://localhost:%s", displayPort)
```

### 3. internal/gateway/server.go âœ…

**ä¿®å¤å†…å®¹**:
- `registerDefaultServices()`: web-ui æœåŠ¡ä»ç¯å¢ƒå˜é‡è¯»å–ç«¯å£

```go
// ä¿®å¤å
port := os.Getenv("PORT")
if port == "" {
    port = "8080"
}
baseURL := fmt.Sprintf("http://localhost:%s", port)
gs.gateway.RegisterService("web-ui", baseURL, baseURL+"/health", "1.0")
```

### 4. internal/gateway/enhanced_server.go âœ…

**ä¿®å¤å†…å®¹**:
- `registerDefaultServices()`: web-ui æœåŠ¡ç«¯å£ä»ç¯å¢ƒå˜é‡è¯»å–

```go
// ä¿®å¤å
mainPort := 8080
if portStr := os.Getenv("PORT"); portStr != "" {
    if p, err := strconv.Atoi(portStr); err == nil {
        mainPort = p
    }
}
defaultServices := []struct{...}{
    {"web-ui", "localhost", mainPort, "/health", "1.0", []string{"ui", "frontend"}},
    // ...
}
```

### 5. config/prometheus.yml âœ…

**ä¿®å¤å†…å®¹**:
- qwq æœåŠ¡ç›‘æ§ç›®æ ‡ä» `qwq:8899` æ”¹ä¸º `qwq:8080`

```yaml
# ä¿®å¤å
- job_name: 'qwq'
  static_configs:
    - targets: ['qwq:8080']  # æ”¹ä¸º 8080
```

## ğŸ“Š ç«¯å£é…ç½®ç»Ÿä¸€è¡¨

| ç»„ä»¶ | å®¹å™¨å†…ç«¯å£ | å®¿ä¸»æœºç«¯å£ | é…ç½®æ–¹å¼ |
|------|-----------|-----------|---------|
| qwq ä¸»æœåŠ¡ | 8080 | 8081 | ç¯å¢ƒå˜é‡ PORT |
| MySQL | 3306 | 3308 | docker-compose.yml |
| Redis | 6379 | 6380 | docker-compose.yml |
| Prometheus | 9090 | 9091 | docker-compose.yml |
| Grafana | 3000 | 3000 | docker-compose.yml |

## ğŸ” éªŒè¯æ–¹æ³•

### 1. æ£€æŸ¥ç¯å¢ƒå˜é‡

```bash
# æŸ¥çœ‹ docker-compose.yml ä¸­çš„é…ç½®
docker compose config | grep PORT
```

é¢„æœŸè¾“å‡º:
```yaml
PORT: "8080"
```

### 2. æ£€æŸ¥å®¹å™¨æ—¥å¿—

```bash
docker compose logs qwq | grep "Dashboard started"
```

é¢„æœŸè¾“å‡º:
```
qwq  | [15:05:40] ğŸš€ qwq Dashboard started at http://localhost:8080
```

### 3. å¥åº·æ£€æŸ¥

```bash
# å®¹å™¨å†…æ£€æŸ¥
docker compose exec qwq curl -f http://localhost:8080/health

# å®¿ä¸»æœºæ£€æŸ¥
curl http://localhost:8081/api/health
```

### 4. Prometheus ç›‘æ§

è®¿é—® http://localhost:9091/targetsï¼Œæ£€æŸ¥ qwq æœåŠ¡çš„ç›®æ ‡åœ°å€æ˜¯å¦ä¸º `qwq:8080`ã€‚

## ğŸš€ é‡æ–°éƒ¨ç½²

ä¿®å¤å®Œæˆåéœ€è¦é‡æ–°æ„å»ºå’Œéƒ¨ç½²ï¼š

```bash
# 1. åœæ­¢æœåŠ¡
docker compose down

# 2. é‡æ–°æ„å»ºï¼ˆä¸ä½¿ç”¨ç¼“å­˜ï¼‰
docker compose build --no-cache

# 3. å¯åŠ¨æœåŠ¡
docker compose up -d

# 4. æŸ¥çœ‹æ—¥å¿—éªŒè¯
docker compose logs -f qwq
```

## ğŸ“ é…ç½®è¯´æ˜

### docker-compose.yml é…ç½®

```yaml
services:
  qwq:
    environment:
      - PORT=8080          # å®¹å™¨å†…ç«¯å£
    ports:
      - "8081:8080"        # å®¿ä¸»æœº:å®¹å™¨
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
```

### .env æ–‡ä»¶é…ç½®ï¼ˆå¯é€‰ï¼‰

```bash
# ä¸»æœåŠ¡ç«¯å£ï¼ˆå®¹å™¨å†…ï¼‰
PORT=8080

# Web UI ç«¯å£ï¼ˆGateway æ¨¡å¼ï¼‰
WEB_UI_PORT=8899

# å®¿ä¸»æœºç«¯å£ï¼ˆåœ¨ docker-compose.yml ä¸­é…ç½®ï¼‰
HOST_PORT=8081
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. Gateway æ¨¡å¼

å¦‚æœä½¿ç”¨ Gateway æ¨¡å¼ï¼ˆ`qwq gateway`ï¼‰ï¼Œä¼šå¯åŠ¨ä¸¤ä¸ªç«¯å£ï¼š
- ç½‘å…³ç«¯å£: ä» PORT ç¯å¢ƒå˜é‡è¯»å–ï¼ˆé»˜è®¤ 8080ï¼‰
- Web UI ç«¯å£: ä» WEB_UI_PORT ç¯å¢ƒå˜é‡è¯»å–ï¼ˆé»˜è®¤ 8899ï¼‰

### 2. Web æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰

å¦‚æœä½¿ç”¨ Web æ¨¡å¼ï¼ˆ`qwq web`ï¼‰ï¼Œåªå¯åŠ¨ä¸€ä¸ªç«¯å£ï¼š
- æœåŠ¡ç«¯å£: ä» PORT ç¯å¢ƒå˜é‡è¯»å–ï¼ˆé»˜è®¤ 8080ï¼‰

### 3. Dockerfile é…ç½®

Dockerfile ä¸­çš„é…ç½®å·²ç»æ­£ç¡®ï¼š

```dockerfile
# æš´éœ²ç«¯å£
EXPOSE 8080

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8080/health || exit 1

# é»˜è®¤å¯åŠ¨å‘½ä»¤
CMD ["/app/qwq", "web"]
```

## ğŸ‰ ä¿®å¤å®Œæˆ

æ‰€æœ‰ç«¯å£é…ç½®å·²ç»Ÿä¸€ï¼š

âœ… ä»£ç ä¸­ç§»é™¤äº†æ‰€æœ‰ç¡¬ç¼–ç çš„ 8899 ç«¯å£  
âœ… æ‰€æœ‰ç«¯å£ä»ç¯å¢ƒå˜é‡ PORT è¯»å–  
âœ… é»˜è®¤ç«¯å£ç»Ÿä¸€ä¸º 8080  
âœ… Prometheus ç›‘æ§é…ç½®å·²æ›´æ–°  
âœ… Gateway æœåŠ¡æ³¨å†Œå·²æ›´æ–°  
âœ… æ—¥å¿—æ˜¾ç¤ºå·²ä¿®å¤  

ç°åœ¨éƒ¨ç½²åçš„æ—¥å¿—åº”è¯¥æ˜¾ç¤ºï¼š

```
qwq  | [15:05:40] æ­£åœ¨æ‰§è¡Œç³»ç»Ÿå·¡æ£€...
qwq  | [15:05:40] ğŸš€ qwq Dashboard started at http://localhost:8080
qwq  | [15:05:40] âœ” ç³»ç»Ÿå¥åº·
qwq  | [15:05:40] ğŸ“… å®šæ—¶ä»»åŠ¡å·²å¯åŠ¨: å·¡æ£€æ¯5åˆ†é’Ÿ, æ—¥æŠ¥æ¯8h0m0s
```

è®¿é—®åœ°å€ï¼š
- **å®¹å™¨å†…**: http://localhost:8080
- **å®¿ä¸»æœº**: http://localhost:8081

---

*ä¿®å¤å®Œæˆæ—¶é—´: 2024-12-08*  
*ä¿®å¤æ–‡ä»¶æ•°: 5*  
*çŠ¶æ€: âœ… å®Œæˆ*
